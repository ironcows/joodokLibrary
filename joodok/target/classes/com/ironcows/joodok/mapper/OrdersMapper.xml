<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="com.ironcows.joodok.mapper.OrdersMapper">


	<select id="getOrderNo" parameterType="String" resultType="String">
		SELECT o.orderNo
		  FROM orders o
		 WHERE o.librarianNo = #{value}
		   AND rownum = 1
		 ORDER BY o.registeredDate DESC
	</select>


	<!-- 주문 1개 선택 -->
	<select id="getOneOrders" parameterType="Orders" resultType="Orders">
		SELECT o.orderNo
			  ,o.librarianNo
			  ,o.registeredDate
			  ,o.modifiedDate
		  FROM orders o
		 WHERE o.orderNo = #{orderNo}
	</select>
	
	<!-- 주문 1개 등록 -->
	<insert id="insertOrders" parameterType="Orders">
		INSERT INTO orders(orderNo
					     ,librarianNo
					     ,tradeEnterpriseNo
					     ,registeredDate)
				<!-- 없으면 YYMMDD0001 부터, 있으면 가장 최근 등록된 레코드의 값에서 자동으로 1씩 증가하게 하자 -->	     
		VALUES((SELECT TO_CHAR(sysdate, 'YYMMDD')||NVL(LPAD(MAX(SUBSTR(o.orderNo, 7, 4))+1, 4, '0'), '0001')
			     FROM orders o
			    WHERE TO_CHAR(sysdate, 'YYMMDD') = SUBSTR(o.orderNo, 1, 6))
			  ,#{librarianNo}
			  ,#{tradeEnterpriseNo}
			  ,sysdate)
	</insert>

</mapper>